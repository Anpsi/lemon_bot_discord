#!/bin/bash

set -e

ROOT="$(dirname "${BASH_SOURCE[0]}")"

function check_dependencies {
  echo "+ Checking dependencies"

  # TODO: Visual C++ build tools
  # http://landinghub.visualstudio.com/visual-cpp-build-tools

  if ! type python &> /dev/null; then
    if ! type python3 &> /dev/null; then
      echo "- Please install python"
      exit 1
    fi
  fi

  if ! type pip &> /dev/null; then
    echo "- Pelase install pip"
    exit 1
  fi

  if ! type virtualenv &> /dev/null; then
    echo "+ Installing virtualenv"
    pip install virtualenv > /dev/null
  fi
}

function start_vm {
  echo "+ Starting virtual machine"
  pushd "$ROOT/local-services"
  vagrant up
  popd
}

function init_virtualenv {
  echo "+ Initializing virtualenv"

  if [ ! -d .venv ]; then
    if type python3 &> /dev/null; then
      virtualenv --python=python3 "$ROOT/.venv" > /dev/null
    else
      virtualenv "$ROOT/.venv" > /dev/null
    fi
  fi

  if [ -f "$ROOT/.venv/Scripts/activate" ]; then
    source "$ROOT/.venv/Scripts/activate"
  elif [ -f "$ROOT/.venv/bin/activate" ]; then
    source "$ROOT/.venv/bin/activate"
  fi

  pip install -r "$ROOT/src/requirements.txt"
}

function syntax_check {
  find "$ROOT/src" -name="*.py" | xargs python -m py_compile
}

function run_bot {
  source secrets
  TZ=UTC python -u src/run_lemon_bot.py
}

check_dependencies
start_vm
init_virtualenv
syntax_check
run_bot
